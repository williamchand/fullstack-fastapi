syntax = "proto3";

package salonapp.v1;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "github.com/williamchand/fullstack-fastapi/backend-go/gen/proto/salonapp/v1;salonappv1";

service BillingService {
  rpc CreateCheckoutSession(CreateCheckoutSessionRequest) returns (CreateCheckoutSessionResponse) {
    option (google.api.http) = { post: "/v1/billing/checkout" body: "*" };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      security: { security_requirement: { key: "BearerAuth" value: {} } }
    };
  }

  // Initiate DOKU Jokul payment and return payment URL
  rpc CreateDokuPayment(CreateDokuPaymentRequest) returns (CreateDokuPaymentResponse) {
    option (google.api.http) = { post: "/v1/billing/doku/payment" body: "*" };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      security: { security_requirement: { key: "BearerAuth" value: {} } }
    };
  }

  rpc GetSubscriptionStatus(google.protobuf.Empty) returns (GetSubscriptionStatusResponse) {
    option (google.api.http) = { get: "/v1/billing/subscription" };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      security: { security_requirement: { key: "BearerAuth" value: {} } }
    };
  }

  rpc HandleWebhook(HandleWebhookRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = { post: "/v1/billing/webhook/{provider}" body: "*" };
  }

  // Refresh payment status by provider and transaction id
  rpc RefreshPaymentStatus(RefreshPaymentStatusRequest) returns (PaymentStatusResponse) {
    option (google.api.http) = { post: "/v1/billing/payments/{transaction_id}/refresh" body: "*" };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      security: { security_requirement: { key: "BearerAuth" value: {} } }
    };
  }

  // Daily subscriptions check (cron-triggered)
  rpc CheckDailySubscriptions(google.protobuf.Empty) returns (CheckDailySubscriptionsResponse) {
    option (google.api.http) = { post: "/v1/billing/subscriptions/check" };
  }
}

message CreateCheckoutSessionRequest {
  string price_id = 1;
  string success_url = 2;
  string cancel_url = 3;
}

message CreateCheckoutSessionResponse { string url = 1; string session_id = 2; }

message CreateDokuPaymentRequest {
  int64 amount_idr = 1; // IDR amount without decimals
  string invoice_number = 2;
  int32 payment_due_minutes = 3; // default 60 if not provided
}

message CreateDokuPaymentResponse { string payment_url = 1; string transaction_id = 2; }

message GetSubscriptionStatusResponse {
  string status = 1;
  string stripe_subscription_id = 2;
  google.protobuf.Timestamp current_period_end = 3;
}

enum Provider {
  PROVIDER_UNSPECIFIED = 0;
  PROVIDER_STRIPE = 1;
  PROVIDER_DOKU = 2;
}

message HandleWebhookRequest { bytes payload = 1; string signature = 2; Provider provider = 3; }

message RefreshPaymentStatusRequest {
  string transaction_id = 1;
  Provider provider = 2; // STRIPE or DOKU
}

message PaymentStatusResponse { string transaction_id = 1; Provider provider = 2; string status = 3; }

message CheckDailySubscriptionsResponse { int32 updated = 1; int32 expired = 2; }
